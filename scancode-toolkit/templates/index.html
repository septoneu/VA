<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Septon European Project - Authentication Setup</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <!-- Header with Welcome Message -->
    <header class="top-banner">
        <h2>Welcome to the Septon European Project</h2>
    </header>

    <!-- Progress Indicator -->
    <div class="progress-indicator">
        <div id="progress-bar"></div>
    </div>

    <div class="container">
        <h1>Authentication</h1>
        <p id="response-message"></p>

        <!-- Step 1: API Key -->
        <div id="step-1" class="step-card active">
            <h2><span class="step-icon">ğŸ”‘</span> Step 1: Enter API Key</h2>
            <div style="display: flex; align-items: center;">
                <input type="text" id="api_key" placeholder="Enter your API Key" aria-label="API Key">
                <div class="tooltip">
                    â—
                    <span class="tooltiptext">Please enter the API Key provided by the manufacturer.</span>
                </div>
            </div>
            <button onclick="submitStep(1)">Next</button>
        </div>

        <!-- Step 2: TOTP Code -->
        <div id="step-2" class="step-card" style="display: none;">
            <h2><span class="step-icon">ğŸ”’</span> Step 2: Enter TOTP Code</h2>
            <div style="display: flex; align-items: center;">
                <input type="text" id="totp_code" placeholder="Enter your TOTP Code" aria-label="TOTP Code">
                <div class="tooltip">
                    â—
                    <span class="tooltiptext">Please enter the time-based OTP generated by your authenticator app.</span>
                </div>
            </div>
            <button onclick="submitStep(2)">Next</button>
        </div>

        <!-- Step 3: JWT Token -->
        <div id="step-3" class="step-card" style="display: none;">
            <h2><span class="step-icon">ğŸ”</span> Step 3: JWT Token Verification</h2>
            <div style="display: flex; align-items: center;">
                <input type="text" id="jwt_token" placeholder="Enter your JWT Token" aria-label="JWT Token">
                <div class="tooltip">
                    â—
                    <span class="tooltiptext">Please enter the JWT token provided to you.</span>
                </div>
            </div>
            <button onclick="submitStep(3)">Next</button>
        </div>

        <!-- Step 4: OAuth Credentials -->
        <div id="step-4" class="step-card" style="display: none;">
            <h2><span class="step-icon">ğŸ›¡ï¸</span> Step 4: Enter OAuth Credentials</h2>
            <div style="display: flex; align-items: center;">
                <label for="client_id">Client ID:</label>
                <input type="text" id="client_id" placeholder="Enter your Client ID" aria-label="Client ID">
                <div class="tooltip">
                    â—
                    <span class="tooltiptext">Please enter your OAuth Client ID.</span>
                </div>
            </div>
            <div style="display: flex; align-items: center; margin-top: 10px;">
                <label for="client_secret">Client Secret:</label>
                <input type="text" id="client_secret" placeholder="Enter your Client Secret" aria-label="Client Secret">
                <div class="tooltip">
                    â—
                    <span class="tooltiptext">Please enter your OAuth Client Secret.</span>
                </div>
            </div>
            <button onclick="submitStep(4)">Next</button>
        </div>

        <!-- Step 5: Retrieve SBOM File -->
        <div id="step-5" class="step-card" style="display: none;">
            <h2><span class="step-icon">ğŸ“„</span> Step 5: Retrieve SBOM File</h2>
            <button onclick="retrieveSBOM()">Download SBOM</button>
            <div id="loading-spinner" style="display: none;">â³ Loading...</div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2024 Septon European Project. All rights reserved.</p>
        <ul class="footer-links">
            <li><a href="/privacy-policy" target="_blank">Privacy Policy</a></li>
            <li><a href="/terms-of-service" target="_blank">Terms of Service</a></li>
        </ul>
    </footer>

    <script>
        let apiKey = null;
        let jwtToken = null;
        let currentStep = 1;

        function submitStep(step) {
            const data = {};

            if (step === 1) {
                apiKey = document.getElementById("api_key").value;
                data.api_key = apiKey;
            } else if (step === 2) {
                const totpCode = document.getElementById("totp_code").value;
                data.totp_code = totpCode;
            } else if (step === 3) {
                data.jwt_token = jwtToken;
            } else if (step === 4) {
                const clientId = document.getElementById("client_id").value;
                const clientSecret = document.getElementById("client_secret").value;
                data.client_id = clientId;
                data.client_secret = clientSecret;
            }

            data.step = step;

            fetch('/submit-credentials', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error("Invalid credentials");
                }
            })
            .then(data => {
                document.getElementById("response-message").textContent = ""; // Clear error message on success
                if (step === 3 && data.token) {
                    jwtToken = data.token;
                }
                goToStep(step + 1);
            })
            .catch(error => {
                document.getElementById("response-message").textContent = error.message || "Error submitting credentials.";
            });
        }

	function goToStep(step) {
    currentStep = step;
    document.querySelectorAll('.step-card').forEach((el) => el.style.display = 'none');
    document.getElementById(`step-${step}`).style.display = 'block';
    updateProgressBar();
}

function updateProgressBar() {
    const progressBar = document.getElementById("progress-bar");
    const percentage = (currentStep - 1) * 25;
    progressBar.style.width = `${percentage}%`;
}

        function retrieveSBOM() {
            document.getElementById("loading-spinner").style.display = "inline-block";
            fetch('/retrieve-sbom', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ api_key: apiKey, jwt_token: jwtToken })
            })
            .then(response => response.ok ? fetch('/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ api_key: apiKey, jwt_token: jwtToken })
            }) : Promise.reject("Failed to retrieve SBOM."))
            .then(downloadResponse => downloadResponse.ok ? downloadResponse.blob() : Promise.reject("Failed to download SBOM."))
            .then(blob => {
                document.getElementById("loading-spinner").style.display = "none";
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "sbom_converted.json";
                document.body.appendChild(a);
                a.click();
                a.remove();
                document.getElementById("response-message").textContent = "SBOM successfully downloaded!";
            })
            .catch(error => {
                document.getElementById("response-message").textContent = error.message || "Error retrieving SBOM.";
            });
        }
    </script>
</body>
</html>
